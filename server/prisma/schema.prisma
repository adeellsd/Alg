// ============================================================================
// RENTALG - SCHEMA PRISMA v6.0 (PRODUCTION-READY OPTIMIZED)
// Marketplace Immobilier Algérien
// Stack: Next.js 14 + Express + PostgreSQL 16 + PostGIS 3.4 + AWS
// 
// CHANGEMENTS MAJEURS v6.0:
// ✅ Conversation refactorisée (1 par paire buyer/seller)
// ✅ Property coordinates avec privacy zones
// ✅ SavedSearch table dédiée (remplace JSON)
// ✅ PropertyPriceHistory pour tracking changements
// ✅ BoostPricing table de référence
// ✅ Review avec conversation OBLIGATOIRE
// ✅ PropertyMedia avec données typées JSON
// ✅ LocationRequest avec enum status et audit
// ✅ Payment avec gestion erreurs/retry
// ✅ Analytics enrichies (sources, devices)
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// ============================================================================
// ENUMS
// ============================================================================

enum AccountStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  BANNED
}

enum AccountTier {
  FREE
  PRO
}

enum PropertyType {
  APARTMENT_F1
  APARTMENT_F2
  APARTMENT_F3
  APARTMENT_F4
  APARTMENT_F5_PLUS
  VILLA
  DUPLEX
  STUDIO
  TERRAIN_CONSTRUCTIBLE
  TERRAIN_AGRICOLE
  LOCAL_COMMERCIAL
  BUREAU
  GARAGE_BOX
  FERME
  OTHER
}

enum TransactionType {
  SALE
  RENT_MONTHLY
  RENT_DAILY
  RENT_YEARLY
}

enum PropertyStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  SOLD
  RENTED
  EXPIRED
  REJECTED
  ARCHIVED
  DELETED
}

enum BoostTier {
  NONE
  TIER_1_EN_AVANT
  TIER_2_PREMIUM
  TIER_3_ULTRA
}

enum BoostStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
  UPGRADED
}

enum HeatingType {
  NONE
  CENTRAL
  INDIVIDUAL
  BOTH
}

enum ViewType {
  SEA
  MOUNTAIN
  CITY
  GARDEN
  STREET
  COURTYARD
  NONE
}

enum MediaType {
  IMAGE
  VIDEO
  BLUEPRINT
  DOCUMENT
}

enum ContactPreference {
  MESSAGE_ONLY
  PHONE_ONLY
  WHATSAPP_ONLY
  BOTH
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum ReportReason {
  FRAUD
  DUPLICATE
  INAPPROPRIATE_CONTENT
  WRONG_CATEGORY
  ALREADY_SOLD
  SPAM
  FAKE_PHOTOS
  WRONG_PRICE
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CHARGILY_CIB
  CHARGILY_EDAHABIA
  BARIDIMOB
  CCP
}

enum PaymentProductType {
  BOOST_TIER_1
  BOOST_TIER_2
  BOOST_TIER_3
  PRO_UPGRADE
  PRO_RENEWAL
}

enum NotificationType {
  BOOST_EXPIRING
  BOOST_EXPIRED
  BOOST_ACTIVATED
  NEW_MESSAGE
  MESSAGE_PURGE_WARNING
  PROPERTY_APPROVED
  PROPERTY_REJECTED
  PROPERTY_EXPIRING
  PROPERTY_EXPIRED
  PROPERTY_LIMIT
  REVIEW_RECEIVED
  NEW_FAVORITE
  LOCATION_REQUEST
  LOCATION_APPROVED
  LOCATION_EXPIRED
  PRO_EXPIRING
  PRO_EXPIRED
  VERIFICATION_REQUIRED
  REPORT_RECEIVED
  ACCOUNT_WARNING
  PRICE_CHANGED
  NEW_MATCH
}

enum LocationInputMode {
  DROPDOWN_MANUAL
  MAP_AUTOCOMPLETE
  MAP_PIN
}

enum LocationRequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  REVOKED
}

// ============================================================================
// USER & AUTH
// ============================================================================

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===== COGNITO =====
  cognitoId String @unique
  email     String @unique
  phone     String? @unique

  emailVerified Boolean @default(false)
  phoneVerified Boolean @default(false)

  // ===== PROFILE =====
  firstName String?
  lastName  String?
  avatar    String?

  // ===== ACCOUNT =====
  accountTier AccountTier   @default(FREE)
  status      AccountStatus @default(PENDING_VERIFICATION)

  // ===== PRO =====
  proActivatedAt     DateTime?
  proExpiresAt       DateTime?
  proAutoRenew       Boolean   @default(false)
  companyName        String?
  companyLogo        String?
  companyDescription String?   @db.Text
  commerceRegister   String?
  taxId              String?

  // ===== CONTACT =====
  showPhone           Boolean           @default(true)
  showWhatsApp        Boolean           @default(false)
  whatsappNumber      String?
  preferredContact    ContactPreference @default(BOTH)

  // ===== PREFERENCES =====
  language           String  @default("fr")
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  pushNotifications  Boolean @default(true)

  // ===== MODERATION =====
  autoApproveProperties Boolean @default(false)
  warningCount          Int     @default(0)
  bannedAt              DateTime?
  banReason             String? @db.Text

  // ===== STATS (Dénormalisé) =====
  totalProperties  Int      @default(0)
  activeProperties Int      @default(0)
  totalViews       Int      @default(0)
  totalFavorites   Int      @default(0)
  averageRating    Decimal? @db.Decimal(3, 2)
  totalReviews     Int      @default(0)

  // ===== ACTIVITY =====
  lastLoginAt    DateTime?
  lastActivityAt DateTime?

  // ===== SOFT DELETE =====
  deletedAt DateTime?

  // ===== RELATIONS =====
  roles        UserRole[]
  properties   Property[]
  favorites    Favorite[]
  savedSearches SavedSearch[]
  
  // Conversations (buyer ou seller)
  conversationsAsBuyer  Conversation[] @relation("BuyerConversations")
  conversationsAsSeller Conversation[] @relation("SellerConversations")
  
  // Messages
  messagesSent     Message[] @relation("SenderMessages")
  messagesReceived Message[] @relation("ReceiverMessages")

  // Reviews
  reviewsGiven    Review[] @relation("ReviewAuthor")
  reviewsReceived Review[] @relation("PropertyOwner")

  // Moderation
  reportsSubmitted Report[] @relation("Reporter")
  reportsReceived  Report[] @relation("ReportedUser")

  // Payments & Boosts
  payments Payment[]
  boosts   PropertyBoost[]

  // Analytics
  propertyViewDetails PropertyViewDetail[]

  // Notifications
  notifications Notification[]

  // Location Requests
  locationRequestsSent     LocationRequest[] @relation("LocationRequester")
  locationRequestsReceived LocationRequest[] @relation("PropertyOwner")

  @@index([cognitoId])
  @@index([email])
  @@index([accountTier])
  @@index([status])
  @@index([proExpiresAt])
  @@index([deletedAt])
  @@map("users")
}

// ============================================================================
// RBAC
// ============================================================================

model Role {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String  @unique
  description String?
  isSystem    Boolean @default(false)

  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model UserRole {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedBy String?
  assignedAt DateTime @default(now())

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Permission {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  code        String @unique
  description String?
  category    String?

  roles RolePermission[]

  @@index([code])
  @@index([category])
  @@map("permissions")
}

model RolePermission {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ============================================================================
// PROPERTIES
// ============================================================================

model Property {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===== OWNER =====
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ===== BASIC =====
  title           String         @db.VarChar(200)
  description     String         @db.Text
  propertyType    PropertyType
  transactionType TransactionType
  status          PropertyStatus @default(PENDING_REVIEW)

  // ===== PRICING =====
  priceAmount     BigInt
  priceNegotiable Boolean @default(false)
  minRentDuration Int?
  rentDeposit     BigInt?

  // ===== DIMENSIONS =====
  surfaceArea Int?
  landArea    Int?

  // ===== ROOMS =====
  totalRooms  Int?
  bedrooms    Int?
  bathrooms   Int?
  kitchens    Int? @default(1)
  livingRooms Int?

  // ===== BUILDING =====
  floor            Int?
  totalFloors      Int?
  buildingAge      Int?
  constructionYear Int?

  // ===== FEATURES =====
  hasElevator        Boolean     @default(false)
  hasBalcony         Boolean     @default(false)
  hasTerrace         Boolean     @default(false)
  hasCellar          Boolean     @default(false)
  hasParking         Boolean     @default(false)
  hasGarage          Boolean     @default(false)
  hasGarden          Boolean     @default(false)
  hasPool            Boolean     @default(false)
  hasAirConditioning Boolean     @default(false)
  heatingType        HeatingType @default(NONE)
  hasEquippedKitchen Boolean     @default(false)
  isFurnished        Boolean     @default(false)
  hasInternet        Boolean     @default(false)
  hasCityGas         Boolean     @default(false)
  hasWater           Boolean     @default(true)
  hasElectricity     Boolean     @default(true)

  // ===== SECURITY =====
  hasGuard        Boolean @default(false)
  hasIntercom     Boolean @default(false)
  hasAlarm        Boolean @default(false)
  hasElectricGate Boolean @default(false)
  hasCCTV         Boolean @default(false)

  // ===== VIEW =====
  viewType ViewType @default(NONE)

  // ===== PROXIMITY (en mètres) =====
  distanceToSchool    Int?
  distanceToTransport Int?
  distanceToShops     Int?
  distanceToMosque    Int?
  distanceToHospital  Int?

  // ===== LEGAL =====
  hasLivretFoncier      Boolean @default(false)
  hasActeVente          Boolean @default(false)
  hasPermisConstruction Boolean @default(false)
  arePapersComplete     Boolean @default(false)

  // ===== CUSTOM FEATURES =====
  customFeatures Json? // ["Panneau solaire", "Double vitrage"]

  // ===== LOCATION (REFACTORÉ) =====
  // Relations normalisées
  wilayaId  String
  wilaya    Wilaya  @relation(fields: [wilayaId], references: [id])
  
  communeId String?
  commune   Commune? @relation(fields: [communeId], references: [id])
  
  // Adresse textuelle
  quartier    String?
  fullAddress String? // Générée: "Rue X, Hydra, Alger"
  postalCode  String? @db.VarChar(10)

  // Coordonnées EXACTES (privées)
  exactLatitude  Decimal @db.Decimal(10, 8)
  exactLongitude Decimal @db.Decimal(11, 8)

  // Coordonnées PUBLIQUES (approximatives si showExactLocation=false)
  publicLatitude  Decimal @db.Decimal(10, 8)
  publicLongitude Decimal @db.Decimal(11, 8)

  showExactLocation Boolean           @default(false)
  privacyRadiusMeters Int            @default(500) // Rayon de flou si privacy=true
  locationInputMode LocationInputMode @default(DROPDOWN_MANUAL)
  mapboxPlaceId     String?

  // ===== STATS (Dénormalisé) =====
  viewsCount     Int @default(0)
  favoritesCount Int @default(0)
  contactsCount  Int @default(0)
  sharesCount    Int @default(0)

  // ===== SEO =====
  slug            String  @unique
  metaTitle       String? @db.VarChar(70)
  metaDescription String? @db.VarChar(160)

  // ===== MODERATION =====
  moderatedAt     DateTime?
  moderatedBy     String?
  rejectionReason String? @db.Text

  // ===== EXPIRATION =====
  expiresAt DateTime?
  isExpired Boolean   @default(false)

  // ===== SOFT DELETE =====
  deletedAt DateTime?

  // ===== RELATIONS =====
  media             PropertyMedia[]
  boost             PropertyBoost?
  favorites         Favorite[]
  savedSearchMatches SavedSearchMatch[]
  priceHistory      PropertyPriceHistory[]
  viewStats         PropertyViewStats[]
  viewDetails       PropertyViewDetail[]
  reports           Report[]
  messages          Message[]
  reviews           Review[]
  locationRequests  LocationRequest[]

  @@index([userId])
  @@index([status])
  @@index([propertyType])
  @@index([transactionType])
  @@index([wilayaId])
  @@index([communeId])
  @@index([slug])
  @@index([priceAmount])
  @@index([priceAmount, transactionType])
  @@index([createdAt(sort: Desc)])
  @@index([status, propertyType, transactionType])
  @@index([status, wilayaId, propertyType])
  @@index([publicLatitude, publicLongitude])
  @@index([status, createdAt(sort: Desc)])
  @@index([deletedAt])
  @@map("properties")
}

// ============================================================================
// PROPERTY PRICE HISTORY (NOUVEAU)
// ============================================================================

model PropertyPriceHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  oldPrice BigInt
  newPrice BigInt
  
  changePercent Decimal @db.Decimal(5, 2) // -15.50 ou +20.00

  changedBy String? // userId qui a fait le changement

  // Notifications envoyées aux favoris
  notificationsSent Int @default(0)
  notifiedAt        DateTime?

  @@index([propertyId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("property_price_history")
}

// ============================================================================
// MEDIA (REFACTORÉ)
// ============================================================================

model PropertyMedia {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  mediaType MediaType

  // ===== IMAGE DATA (JSON typé) =====
  imageData Json? 
  /* Structure:
  {
    "url": "https://cdn.../original.jpg",
    "thumbnailUrl": "https://cdn.../thumb_300x200.jpg",
    "mediumUrl": "https://cdn.../medium_800x600.jpg",
    "largeUrl": "https://cdn.../large_1920x1080.jpg",
    "blurhash": "LKO2?V%2Tw=w]~RBVZRi};RPxuwH",
    "dominantColor": "#3b82f6",
    "width": 1920,
    "height": 1080,
    "format": "jpeg",
    "sizeBytes": 245678,
    "altText": "Salon moderne avec vue"
  }
  */

  // ===== VIDEO DATA (JSON typé) =====
  videoData Json?
  /* Structure:
  {
    "platform": "TIKTOK" | "INSTAGRAM_REEL" | "YOUTUBE" | "S3_UPLOAD",
    "url": "https://...",
    "embedUrl": "https://...",
    "thumbnailUrl": "https://...",
    "duration": 45,
    "width": 1080,
    "height": 1920,
    "format": "mp4",
    "sizeBytes": 5678901
  }
  */

  // ===== ORDERING =====
  displayOrder Int     @default(0)
  isPrimary    Boolean @default(false)

  // ===== SOFT DELETE =====
  deletedAt DateTime?

  @@index([propertyId])
  @@index([mediaType])
  @@index([displayOrder])
  @@index([isPrimary])
  @@index([deletedAt])
  @@map("property_media")
}

// ============================================================================
// BOOST SYSTEM
// ============================================================================

// Table de référence des prix (NOUVEAU)
model BoostPricing {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tier BoostTier @unique

  pricePerWeek BigInt
  pricePerMonth BigInt?
  
  features Json // ["Top résultats", "Badge doré", etc.]

  validFrom  DateTime @default(now())
  validUntil DateTime?

  isActive Boolean @default(true)

  @@index([tier])
  @@index([validFrom, validUntil])
  @@map("boost_pricing")
}

model PropertyBoost {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  propertyId String   @unique
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  boostTier BoostTier

  startDate DateTime    @default(now())
  endDate   DateTime
  status    BoostStatus @default(PENDING)

  amountPaid     BigInt
  priceReference BigInt // Prix au moment de l'achat (historique)

  previousTier      BoostTier?
  isUpgrade         Boolean    @default(false)
  upgradeAmountPaid BigInt?

  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  expirationNotificationSent Boolean   @default(false)
  notificationSentAt         DateTime?

  totalImpressions Int @default(0)
  totalClicks      Int @default(0)

  @@index([propertyId])
  @@index([userId])
  @@index([status])
  @@index([boostTier])
  @@index([endDate])
  @@index([status, endDate])
  @@map("property_boosts")
}

// ============================================================================
// LOCATION PRIVACY (REFACTORÉ)
// ============================================================================

model LocationRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  requesterId String
  requester   User   @relation("LocationRequester", fields: [requesterId], references: [id], onDelete: Cascade)

  ownerId String
  owner   User   @relation("PropertyOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  message String? @db.Text

  status LocationRequestStatus @default(PENDING)
  
  approvedAt DateTime?
  rejectedAt DateTime?
  expiresAt  DateTime? // 24h après approval
  revokedAt  DateTime?

  rejectionReason String? @db.Text
  revokedBy       String?

  // Audit trail
  viewedAt  DateTime?
  viewCount Int      @default(0)

  @@unique([propertyId, requesterId])
  @@index([propertyId])
  @@index([requesterId])
  @@index([ownerId])
  @@index([status])
  @@index([expiresAt])
  @@map("location_requests")
}

// ============================================================================
// FAVORITES
// ============================================================================

model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  notifyPriceChange Boolean @default(false)

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
  @@index([notifyPriceChange])
  @@index([createdAt(sort: Desc)])
  @@map("favorites")
}

// ============================================================================
// SAVED SEARCHES (NOUVEAU - Remplace JSON)
// ============================================================================

model SavedSearch {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name String @db.VarChar(100)

  // Critères de recherche (JSON pour flexibilité)
  criteria Json
  /* Structure:
  {
    "wilayaId": "...",
    "communeId": "...",
    "propertyType": ["APARTMENT_F3", "APARTMENT_F4"],
    "transactionType": "SALE",
    "minPrice": 5000000,
    "maxPrice": 10000000,
    "minSurface": 80,
    "hasParking": true,
    ...
  }
  */

  notifyByEmail Boolean @default(true)
  notifyInApp   Boolean @default(true)
  isActive      Boolean @default(true)

  // Stats
  lastMatchedAt DateTime?
  matchCount    Int      @default(0)
  
  // Dernière notification envoyée
  lastNotifiedAt DateTime?

  matches SavedSearchMatch[]

  @@index([userId])
  @@index([isActive])
  @@index([userId, isActive])
  @@index([lastMatchedAt])
  @@map("saved_searches")
}

model SavedSearchMatch {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  savedSearchId String
  savedSearch   SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  notified Boolean   @default(false)
  viewedAt DateTime?

  @@unique([savedSearchId, propertyId])
  @@index([savedSearchId])
  @@index([propertyId])
  @@index([createdAt(sort: Desc)])
  @@map("saved_search_matches")
}

// ============================================================================
// MESSAGING (REFACTORÉ - 1 conversation par paire)
// ============================================================================

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===== PARTICIPANTS =====
  buyerId String
  buyer   User   @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)

  sellerId String
  seller   User   @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)

  // ===== CONTEXT (optionnel) =====
  lastPropertyId String? // Dernière annonce discutée

  // ===== READ STATUS =====
  buyerLastReadAt   DateTime?
  sellerLastReadAt  DateTime?
  buyerUnreadCount  Int       @default(0)
  sellerUnreadCount Int       @default(0)

  // ===== PREFERENCES =====
  buyerMuted     Boolean @default(false)
  sellerMuted    Boolean @default(false)
  buyerArchived  Boolean @default(false)
  sellerArchived Boolean @default(false)

  // ===== MESSAGES =====
  messages Message[]

  // ===== METADATA =====
  lastMessageAt DateTime @default(now())

  // ===== AUTO-PURGE =====
  keepIndefinitely Boolean   @default(false)
  purgeWarningAt   DateTime?

  // ===== STATS =====
  totalMessages Int @default(0)

  // ===== SOFT DELETE =====
  deletedAt DateTime?

  // ===== RELATIONS =====
  reviews Review[]

  @@unique([buyerId, sellerId]) // 1 conversation par paire
  @@index([buyerId])
  @@index([sellerId])
  @@index([lastMessageAt(sort: Desc)])
  @@index([keepIndefinitely])
  @@index([purgeWarningAt])
  @@index([deletedAt])
  @@map("conversations")
}

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation("SenderMessages", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId String
  receiver   User   @relation("ReceiverMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  // ===== CONTEXT (NOUVEAU) =====
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  content String @db.Text

  attachments Json? // [{type: "image", url: "..."}, ...]

  status MessageStatus @default(SENT)
  readAt DateTime?

  // ===== SOFT DELETE =====
  deletedAt DateTime?

  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
  @@index([propertyId])
  @@index([createdAt(sort: Desc)])
  @@index([status])
  @@index([receiverId, readAt])
  @@map("messages")
}

// ============================================================================
// REVIEWS (REFACTORÉ - Conversation OBLIGATOIRE)
// ============================================================================

model Review {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===== CONVERSATION (OBLIGATOIRE) =====
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // ===== DERIVED FROM CONVERSATION =====
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  ownerId String
  owner   User   @relation("PropertyOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User   @relation("ReviewAuthor", fields: [reviewerId], references: [id], onDelete: Cascade)

  rating  Int // 1-5
  comment String? @db.Text
  tags    String[] // ["Réactif", "Sérieux", "Prix négociable"]

  helpfulCount Int @default(0)

  isReported Boolean @default(false)
  isHidden   Boolean @default(false)
  hiddenAt   DateTime?
  hiddenBy   String?

  ownerResponse    String?   @db.Text
  ownerRespondedAt DateTime?

  @@unique([conversationId]) // 1 review par conversation
  @@index([propertyId])
  @@index([reviewerId])
  @@index([ownerId])
  @@index([rating])
  @@index([isHidden])
  @@index([createdAt(sort: Desc)])
  @@map("reviews")
}

// ============================================================================
// MODERATION
// ============================================================================

model Report {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reporterId String
  reporter   User   @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  reportedUserId String?
  reportedUser   User?   @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: SetNull)

  reason      ReportReason
  description String?      @db.Text
  status      ReportStatus @default(PENDING)

  evidenceUrls String[]

  reviewedAt  DateTime?
  reviewedBy  String?
  adminNotes  String? @db.Text
  actionTaken String?

  @@index([propertyId])
  @@index([reportedUserId])
  @@index([reporterId])
  @@index([status])
  @@index([reason])
  @@index([createdAt(sort: Desc)])
  @@map("reports")
}

// ============================================================================
// PAYMENTS (REFACTORÉ avec gestion erreurs)
// ============================================================================

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount   BigInt
  currency String @default("DZD")

  method PaymentMethod
  status PaymentStatus @default(PENDING)

  chargilyTransactionId String? @unique
  chargilyPaymentUrl    String?
  chargilyInvoiceId     String?
  chargilyWebhookData   Json?

  productType    PaymentProductType
  productDetails Json?

  boosts PropertyBoost[]

  // ===== FAILURE HANDLING (NOUVEAU) =====
  failureReason String? @db.Text
  failureCode   String?
  retryCount    Int      @default(0)
  lastRetryAt   DateTime?
  maxRetries    Int      @default(3)

  // ===== WEBHOOK TRACKING (NOUVEAU) =====
  webhookReceivedAt DateTime?
  webhookVerified   Boolean  @default(false)

  // ===== REFUND =====
  refundedAt   DateTime?
  refundAmount BigInt?
  refundReason String?   @db.Text
  refundedBy   String?

  // ===== INVOICE =====
  invoiceNumber String? @unique
  invoiceUrl    String?

  // ===== METADATA =====
  metadata  Json?
  ipAddress String?
  userAgent String?

  @@index([userId])
  @@index([status])
  @@index([productType])
  @@index([method])
  @@index([createdAt(sort: Desc)])
  @@index([chargilyTransactionId])
  @@map("payments")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String           @db.VarChar(200)
  message String           @db.Text

  propertyId String?
  link       String?

  isRead Boolean   @default(false)
  readAt DateTime?

  isEmailed Boolean   @default(false)
  emailedAt DateTime?
  isPushed  Boolean   @default(false)
  pushedAt  DateTime?

  metadata Json?

  deletedAt DateTime?

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt(sort: Desc)])
  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([deletedAt])
  @@map("notifications")
}

// ============================================================================
// ANALYTICS (REFACTORÉ avec enrichissement)
// ============================================================================

model PropertyViewStats {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  date DateTime @db.Date

  // ===== VIEWS =====
  totalViews     Int @default(0)
  uniqueVisitors Int @default(0)

  // ===== ENGAGEMENT =====
  avgDuration Int?
  bounceRate  Decimal? @db.Decimal(5, 2)
  conversions Int      @default(0)

  // ===== SOURCES (NOUVEAU) =====
  sourceBreakdown Json?
  /* Structure:
  {
    "direct": 45,
    "google": 30,
    "boost": 25,
    "social": 15,
    "referral": 10
  }
  */

  // ===== DEVICES (NOUVEAU) =====
  deviceBreakdown Json?
  /* Structure:
  {
    "mobile": 60,
    "desktop": 35,
    "tablet": 5
  }
  */

  @@unique([propertyId, date])
  @@index([propertyId, date(sort: Desc)])
  @@index([date])
  @@map("property_view_stats")
}

model PropertyViewDetail {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  ipAddress String?
  userAgent String? @db.Text
  referer   String? @db.Text
  sessionId String?

  country String?
  city    String?

  durationSeconds Int?
  didContact      Boolean @default(false)
  didFavorite     Boolean @default(false)

  source   String?
  campaign String?
  device   String? // mobile, desktop, tablet

  @@index([propertyId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([sessionId])
  @@index([source])
  @@index([device])
  @@map("property_view_details")
}

model PopularSearch {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wilayaId        String?
  propertyType    PropertyType?
  transactionType TransactionType?
  minPrice        BigInt?
  maxPrice        BigInt?

  searchCount    Int      @default(1)
  lastSearchedAt DateTime @default(now())

  cachedResults  Json?
  cacheExpiresAt DateTime?
  cacheTTL       Int      @default(3600) // 1h en secondes

  @@unique([wilayaId, propertyType, transactionType, minPrice, maxPrice])
  @@index([searchCount(sort: Desc)])
  @@index([cacheExpiresAt])
  @@index([lastSearchedAt])
  @@map("popular_searches")
}

// ============================================================================
// GEOGRAPHY
// ============================================================================

model Wilaya {
  id   String @id @default(cuid())
  code String @unique
  name String @unique
  nameAr String?
  nameFr String?

  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  population Int?
  area       Int?

  communes   Commune[]
  properties Property[]

  @@index([code])
  @@index([name])
  @@map("wilayas")
}

model Commune {
  id   String @id @default(cuid())
  code String @unique
  name String
  nameAr String?
  nameFr String?

  wilayaId String
  wilaya   Wilaya @relation(fields: [wilayaId], references: [id])

  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  population Int?
  postalCode String? @db.VarChar(10)

  properties Property[]

  @@index([wilayaId])
  @@index([code])
  @@index([name])
  @@map("communes")
}